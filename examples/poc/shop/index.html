<!DOCTYPE html>
<html>

<head>
  <h2 data-intro-group="tutorial"
    data-intro='Denna webbsida simulerar vyn för en butikskund i en affär som har befogenhet att genenera kvitton.'
    style="color: rgb(135, 129, 211)">
    Affärsfönster
  </h2>
  <link rel="stylesheet" type="text/css" href="css.css" />
  <link rel="stylesheet" type="text/css" href="/intro.js/introjs.css" />
</head>

<body>
  <script type="text/javascript" src="/intro.js/intro.js"></script>

  <form action="/buy" method="POST" id="buyForm">
    <label for="Företag"> Företag </label>
    <br>
    <input name="businessName" value="Tågresor.se" />
    </input>
    <br>
    <label for="organisationsId"> OrganisationsId </label>
    <br>
    <input name="orgId" value="123" />
    </input>
    <h3>
      Köp produkt
    </h3>

    <div data-intro-group="tutorial" data-intro='Här kan du fylla i vilken artikel som kunden köper och vad den kostar.'
      style="display: table-cell;">
      <ul>
        <li>
          <label for="date"> Datum </label>
          <label class="time" for="time"> tid </label>
          <br>
          <input name="date" type="date" id="date" value="YYYY-MM-DD" />
          </input>
          <input name="time" type="time" id="time" value="16:48" />
          </input>
        </li>
        <li>
          <label for="ref"> KvittoId </label>
          <br>
          <input name="ref" id="ref">
          </input>
        </li>
        <li>
          <label for="articleName"> Artikelnamn </label>
          <br>
          <input name="articleName" id="articleName" value="Tågbiljett">
          </input>
        </li>
        <li>
          <label for="amount"> Belopp </label>
          <br>
          <input name="amount" id="amount" value="100">
          </input>
        </li>
        <li>
          <label for="tax"> Moms </label>
          <br>
          <input name="tax" id="tax" value="25">
          </input>
        </li>
        <li>
          <label for="currency"> Valuta </label>
          <br>
          <input name="currency" id="currency" value="SEK">
          </input>
        </li>
        <li>
          <label for="currency"> Faktura </label>
          <br>
          <input type="checkbox" name="invoice" id="invoice">
          </input>
        </li>
      </ul>
    </div>
  </form>

  <div id="buy">
    <button data-intro-group="tutorial"
      data-intro="Tryck nu på köp för att simulera att kvittot genereras och skickas iväg till kundens email"
      onclick="buy()">KÖP</button>
    <div data-intro-group="tutorial2" data-intro="Köpet är gjort:
      </br>
      1. Kvittot är genenerat
      </br>
      2. Det genererade kvittot körs genom en hash-algoritm och signeras digitalt.
      </br>
      3. Den signerade hashen skickas till hash-registret.
      </br>
      4. Butikskunden har fått ett email med kvittot bifogat
      </br>
      </br>
      Om vi nu går tillbaka till hash-registret kan vi se att kvittot har registrerats." id='check-box'
      style="visibility: hidden; color: green; font-size:100px; width:120px; ">&#9989</div>
  </div>
  <script type="text/javascript">
    const intro = introJs()
    const urlParams = new URLSearchParams(window.location.search)
    if (urlParams.has('tutorial') || urlParams.has('tutorial2')) {
      if (urlParams.has('tutorial2')) {
        intro.setOptions({
          'hidePrev': true,
          'hideNext': true,
          'showStepNumbers': false,
          'doneLabel': 'Tillbaka till hash-registret',
          'nextLabel': 'Nästa'
        })
        document.getElementById(
            'check-box'
          ).innerHTML =
          `<div id='check-box' style="visibility: visible; color: green; font-size:100px ">&#9989</div>`
      } else {
        intro.setOptions({
          'hidePrev': true,
          'hideNext': true,
          'showStepNumbers': false,
          'doneLabel': 'skip',
          'nextLabel': 'Nästa'
        })
      }
      let completed
      const introGroup = urlParams.has('tutorial2') ? "tutorial2" : "tutorial"
      intro.start(introGroup).oncomplete(function () {
        completed = true
        if (introGroup === "tutorial") {
          window.location.href = 'http://' + window.location.host + '/?tutorial2=true';
        } else {
          const frontpage_url = window.location.hostname === "localhost" ? "http://localhost:6900" :
            "https://www.digitala-kvitton.se"
          window.location.href = frontpage_url + '/?intro=hash-registry';
        }
      });
      intro.onexit(function (e) {
        if (!completed) {
          window.location.href = 'http://' + window.location.host;
        }
      });
    }

    function setId() {
      var ref = document.querySelector(`#ref`);
      ref.value = Date.now();
    }
    setId()

    function setDate() {
      const myDate = document.querySelector(`input[type="date"]`);
      const myTime = document.querySelector(`input[type="time"]`);
      const today = new Date();
      today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
      myDate.value = today.toJSON().substring(0, 10)
      myTime.value = today.toJSON().substring(11, 16)
    }

    setDate()
    async function buy() {
      const urlParams = new URLSearchParams(window.location.search)

      var form = document.querySelector('form');
      var formData = new FormData(form);
      var req = new XMLHttpRequest();
      req.open('POST', '/buy')
      req.onload = function (e) {
        var code = req.status;
        var text = req.statusText;

        if (code === 200) {
          document.getElementById(
              'check-box'
            ).innerHTML =
            `<div id='check-box' style="visibility: visible; color: green; font-size:100px ">&#9989</div>`
          setTimeout(() => {
            document.getElementById(
                'buy'
              ).innerHTML =
              `<button onclick="buy()">KÖP</button>`
          }, 5500)
          if (urlParams.has('tutorial')) {
            intro.start('tutorial2')
          }
        } else {
          alert(req.responseText)
        }
      }
      req.send(formData)
    }
  </script>
</body>

</html>